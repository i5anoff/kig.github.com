var specialKeys = {id: true, fCurves: true, tweenCurves: true, time: true, name: true};

var savedTimeline = '{"version":1,"looping":true,"animationDuration":5.833333333333333,"timeline":{"Sky":[{"time":0,"tweenCurves":{"position":[[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1]]},"fCurves":{"position":[[-0.25,0,0.25,0],[-0.25,0,0.25,0],[-0.25,0,0.25,0]]},"position":[-8.5,3.5,5.400000095367432]}],"Camera":[{"time":0,"tweenCurves":{"position":[[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1]],"target":[[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1]]},"fCurves":{"position":[[-0.275,2.9179204902648928,0.275,-2.9179204902648928],[-0.275,-0.15322060132026674,0.275,0.15322060132026674],[-0.275,-0.41974614572525026,0.275,0.41974614572525026],[-0.275,0.10166754538578772,0.275,-0.10166754538578772]],"target":[[-0.275,0.9582709193229676,0.275,-0.9582709193229676],[-0.275,-0.7814070596694946,0.275,0.7814070596694946],[-0.275,-0.14377899742126465,0.275,0.14377899742126465],[-0.275,0,0.275,0]]},"position":[0,0,-13,0],"target":[0,0,0,1]},{"time":0.8333333333333334,"tweenCurves":{"position":[[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1]],"target":[[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1]]},"fCurves":{"position":[[-0.24749999999999994,0.6280922909786826,0.24749999999999994,-0.6280922909786826],[-0.24749999999999994,-0.8584401188398662,0.24749999999999994,0.8584401188398662],[-0.24749999999999994,-3.7395480507298515,0.24749999999999994,3.7395480507298515],[-0.24749999999999994,-0.08895637505932856,0.24749999999999994,0.08895637505932856]],"target":[[-0.24749999999999994,-0.7253451196770918,0.24749999999999994,0.7253451196770918],[-0.24749999999999994,-0.9434977709619621,0.24749999999999994,0.9434977709619621],[-0.24749999999999994,-0.10975407355710078,0.24749999999999994,0.10975407355710078],[-0.24749999999999994,0,0.24749999999999994,0]]},"position":[-14.218812942504883,-0.9517351984977722,-1.1079767942428589,3.9227458614732313e-8],"target":[-7.876337051391602,6.95311164855957,7.965695858001709,1]},{"time":1.5833333333333333,"tweenCurves":{"position":[[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1]],"target":[[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1]]},"fCurves":{"position":[[-0.24749999999999997,-1.8895310357997293,0.24749999999999997,1.8895310357997293],[-0.24749999999999997,0.11764572510593817,0.24749999999999997,-0.11764572510593817],[-0.24749999999999997,-0.8258096621538463,0.24749999999999997,0.8258096621538463],[-0.24749999999999997,-0.20819052785748302,0.24749999999999997,0.20819052785748302]],"target":[[-0.24749999999999997,-2.663297406246788,0.24749999999999997,2.663297406246788],[-0.24749999999999997,1.4775606679916382,0.24749999999999997,-1.4775606679916382],[-0.24749999999999997,1.7029201325617338,0.24749999999999997,-1.7029201325617338],[-0.24749999999999997,0,0.24749999999999997,0]]},"position":[-4.018098831176758,5.49170446395874,10.92303466796875,0.56908118724823],"target":[4.640254974365234,6.035844326019287,0.7021304368972778,1]},{"time":2.4166666666666665,"tweenCurves":{"position":[[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1]],"target":[[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1]]},"fCurves":{"position":[[-0.2475,-3.291967807569002,0.2475,3.291967807569002],[-0.2475,1.6440838766098023,0.2475,-1.6440838766098023],[-0.2475,2.5592833102376837,0.2475,-2.5592833102376837],[-0.2475,-0.1872786445366709,0.2475,0.1872786445366709]],"target":[[-0.2475,-0.08949581924237703,0.2475,0.08949581924237703],[-0.2475,0.629151128844211,0.2475,-0.629151128844211],[-0.2475,0.43784078704683405,0.2475,-0.43784078704683405],[-0.2475,0,0.2475,0]]},"position":[-2.130903959274292,-1.7043509483337402,4.174980640411377,1.3318586349487305],"target":[9.161592483520508,-2.4992966651916504,-2.928406000137329,1]},{"time":3.1666666666666665,"tweenCurves":{"position":[[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1]],"target":[[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1]]},"fCurves":{"position":[[-0.2475,-1.1443123596448166,0.2475,1.1443123596448166],[-0.2475,0.046622875103583705,0.2475,-0.046622875103583705],[-0.2475,0.9667181484515851,0.2475,-0.9667181484515851],[-0.2475,0.06415770223507515,0.2475,-0.06415770223507515]],"target":[[-0.2475,1.1169828859200845,0.2475,-1.1169828859200845],[-0.2475,-0.4035382249722114,0.2475,0.4035382249722114],[-0.2475,-1.120017502949788,0.2475,1.120017502949788],[-0.2475,0,0.2475,0]]},"position":[17.041627883911133,-5.026003837585449,-5.449484825134277,1.7671600580215454],"target":[5.21278715133667,2.010971784591675,-2.0988712310791016,1]},{"time":4.583333333333333,"tweenCurves":{"position":[[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1]],"target":[[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1]]},"fCurves":{"position":[[-0.4125000000000001,2.636126813292504,0.4125000000000001,-2.636126813292504],[-0.4125000000000001,-0.7774599686264994,0.4125000000000001,0.7774599686264994],[-0.4125000000000001,1.1679703161120418,0.4125000000000001,-1.1679703161120418],[-0.4125000000000001,0.27335757147520784,0.4125000000000001,-0.27335757147520784]],"target":[[-0.4125000000000001,0.8063530124723913,0.4125000000000001,-0.8063530124723913],[-0.4125000000000001,0.31107219792902474,0.4125000000000001,-0.31107219792902474],[-0.4125000000000001,-0.3246691435575486,0.4125000000000001,0.3246691435575486],[-0.4125000000000001,0,0.4125000000000001,0]]},"position":[7.886645317077637,-2.112497329711914,-4.287871837615967,0.7702087163925171],"target":[-0.6167088747024536,1.0333611965179443,6.876461029052734,1]}],"Sphere 0":[{"time":0,"tweenCurves":{"position":[[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1]]},"fCurves":{"position":[[-1.925,0,1.925,0],[-1.925,0,1.925,0],[-1.925,0,1.925,0],[-1.925,0,1.925,0]]},"position":[1.4612228870391846,4.168397903442383,1.383209228515625,1]}],"Sphere 1":[{"time":0,"tweenCurves":{"position":[[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1]]},"fCurves":{"position":[[-0.275,3.1206098147801002,0.275,-3.1206098147801002],[-0.275,0.15816724640982496,0.275,-0.15816724640982496],[-0.275,-0.5862852862903052,0.275,0.5862852862903052],[-0.275,0,0.275,0]]},"position":[1.21330726146698,0.7952590584754944,-3.5843122005462646,1]},{"time":0.8333333333333334,"tweenCurves":{"position":[[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1]]},"fCurves":{"position":[[-0.275,0.3133391508034298,0.275,-0.3133391508034298],[-0.275,-0.8583906148161208,0.275,0.8583906148161208],[-0.275,-2.0256318398884368,0.275,2.0256318398884368],[-0.275,0,0.275,0]]},"position":[-12.453531265258789,2.457167148590088,1.5241636037826538,1]},{"time":1.75,"tweenCurves":{"position":[[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1]]},"fCurves":{"position":[[-0.3025,-2.8104386415481573,0.3025,2.8104386415481573],[-0.3025,1.110669165802002,0.3025,-1.110669165802002],[-0.3025,0.741750686788559,0.3025,-0.741750686788559],[-0.3025,0,0.3025,0]]},"position":[-0.7806691527366638,6.257744789123535,9.306072235107422,1]},{"time":2.9166666666666665,"tweenCurves":{"position":[[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1]]},"fCurves":{"position":[[-0.3025000000000001,-1.9072118561983116,0.3025000000000001,1.9072118561983116],[-0.3025000000000001,0.287881028366089,0.3025000000000001,-0.287881028366089],[-0.3025000000000001,1.871683820056916,0.3025000000000001,-1.871683820056916],[-0.3025000000000001,0,0.3025000000000001,0]]},"position":[6.902106761932373,-5.1920695304870605,-3.5843122005462646,1]},{"time":3.8333333333333335,"tweenCurves":{"position":[[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1]]},"fCurves":{"position":[[-0.3025000000000001,-0.07604669511318209,0.3025000000000001,0.07604669511318209],[-0.3025000000000001,-1.3091830223798755,0.3025000000000001,1.3091830223798755],[-0.3025000000000001,-0.20835737735033039,0.3025000000000001,0.20835737735033039],[-0.3025000000000001,0,0.3025000000000001,0]]},"position":[12.354398727416992,4.275093078613281,-3.5843122005462646,1]},{"time":4.916666666666667,"tweenCurves":{"position":[[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1]]},"fCurves":{"position":[[-0.3024999999999998,1.6850900842249388,0.3024999999999998,-1.6850900842249388],[-0.3024999999999998,0.52632489554584,0.3024999999999998,-0.52632489554584],[-0.3024999999999998,0,0.3024999999999998,0],[-0.3024999999999998,0,0.3024999999999998,0]]},"position":[7.404894828796387,3.463685989379883,-2.206742763519287,1]}],"Sphere 2":[{"time":0,"tweenCurves":{"position":[[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1]]},"fCurves":{"position":[[-1.925,0,1.925,0],[-1.925,0,1.925,0],[-1.925,0,1.925,0],[-1.925,0,1.925,0]]},"position":[-5.1920485496521,2.7815699577331543,0.7986268997192383,1]}],"Sphere 3":[{"time":0,"tweenCurves":{"position":[[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1]]},"fCurves":{"position":[[-1.925,0,1.925,0],[-1.925,0,1.925,0],[-1.925,0,1.925,0],[-1.925,0,1.925,0]]},"position":[0.11020421981811523,0.7133102416992188,4.1859869956970215,1]}],"Sphere 4":[{"time":0,"tweenCurves":{"position":[[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1]]},"fCurves":{"position":[[-1.925,0,1.925,0],[-1.925,0,1.925,0],[-1.925,0,1.925,0],[-1.925,0,1.925,0]]},"position":[-0.021173402667045593,-3.2843713760375977,1.8057727813720703,1]}],"Sphere 5":[{"time":0,"tweenCurves":{"position":[[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1]]},"fCurves":{"position":[[-1.925,0,1.925,0],[-1.925,0,1.925,0],[-1.925,0,1.925,0],[-1.925,0,1.925,0]]},"position":[4.87290096282959,3.5766348838806152,-3.134150505065918,1]}],"Sphere 6":[{"time":0,"tweenCurves":{"position":[[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1]]},"fCurves":{"position":[[-1.925,0,1.925,0],[-1.925,0,1.925,0],[-1.925,0,1.925,0],[-1.925,0,1.925,0]]},"position":[-6.735741138458252,-3.605172872543335,-1.7387723922729492,1]}],"Sphere 7":[{"time":0,"tweenCurves":{"position":[[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1]]},"fCurves":{"position":[[-1.925,0,1.925,0],[-1.925,0,1.925,0],[-1.925,0,1.925,0],[-1.925,0,1.925,0]]},"position":[-3.023514986038208,-0.5737624764442444,1.893345832824707,1]}],"Sphere 8":[{"time":0,"tweenCurves":{"position":[[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1],[0,0,0.25,0.25,0.75,0.75,1,1]]},"fCurves":{"position":[[-0.25,0,0.25,0],[-0.25,0,0.25,0],[-0.25,0,0.25,0],[-0.25,0,0.25,0]]},"position":[-3.5648510456085205,1.966158390045166,3.7201287746429443,1]}]}}';

if (!NodeList.prototype.forEach) {
	NodeList.prototype.forEach = function(f) {
		return [].slice.call(this).forEach(f);
	};
}

var scrollIntoViewIfNeeded = function(el) {
	if (el.scrollIntoViewIfNeeded) {
		el.scrollIntoViewIfNeeded();
	} else {
		var bbox = el.getBoundingClientRect();
		var pbb = el.parentNode.getBoundingClientRect();
		if (bbox.left >= pbb.right || bbox.right <= pbb.left || bbox.top >= pbb.bottom || bbox.bottom <= pbb.top) {
			el.scrollIntoView();
		}
	}
};

(function(){
var init = function() {
	if (DEBUG) console.log('script start to execute: '+(Date.now()-window.startScript)+' ms');

	var iResolution = vec3(glc.width, glc.height, 1.0);

	var setShader = function(p) {
		gl.useProgram(p);
		startT = Date.now();
		u3fv(gl, p, 'iResolution', iResolution);
		u1i(gl, p, 'iChannel0', 0);
		u1i(gl, p, 'iChannel1', 1);
		u1i(gl, p, 'iChannel2', 2);
		var pos = gl.getAttribLocation(p, 'position');
		gl.enableVertexAttribArray(pos);
		gl.vertexAttribPointer(pos, 3, gl.FLOAT, false, 0, 0);
	};

	var currentShader;

	var setShaderN = function(name, shader) {
		if (currentShader === name) {
			return shader;
		}
		currentShader = name;
		p = shader;
		if (typeof p === 'string') {
			p = createProgram(gl, rtShader, p);
		}
		setShader(p);
		return p;
	};

	var setStaticShader = function() {
		staticShader = setShaderN('static', staticShader);
	};

	var setAnimShader = function() {
		animShader = setShaderN('anim', animShader);
	};

	var setHiresShader = function() {
		hiresShader = setShaderN('hires', hiresShader);
	};

	var hiresShader, staticShader, animShader, p;

	var rtVert = 'precision highp float;attribute vec3 position;void main() {gl_Position = vec4(position, 1.0);}';
	var rtShader = createShader(gl, rtVert, gl.VERTEX_SHADER);

	Loader.get(shaderURLs, function(mblurFrag) {

		if (gl.floatTexture) {
			mblurFrag = "#define OES_TEXTURE_FLOAT\n" + mblurFrag;
		}

		hiresShader = mblurFrag.replace("#define MBLUR_SAMPLES 4.0", "#define MBLUR_SAMPLES 64.0");
		staticShader = mblurFrag.replace("#define MBLUR_SAMPLES 4.0", "#define MBLUR_SAMPLES 4.0");
		animShader = mblurFrag.replace("#define MBLUR_SAMPLES 4.0", "#define MBLUR_SAMPLES 1.0");

		var forceRedraw = false;
		var t1 = Date.now();
		var t0 = Date.now();
		var buf = createBuffer(gl);
		var rTex = createTexture(gl, randomTex, 0);
		var objectBuf = new Float32Array(4*16*2);
		var objectPositions = new Float32Array(objectBuf.buffer, 0, 4*16);
		var objectVelocities = new Float32Array(objectBuf.buffer, 4*16*4, 4*16);
		for (var i=0; i<objectPositions.length; i+=4) {
			objectPositions[i+3] = -1;
		}
		objectBuf.width = 16;
		objectBuf.height = 2;
		var pTex;
		if (gl.floatTexture) {
			pTex = createTexture(gl, objectBuf, 1);
		}

		var objectMaterials = new Uint8Array(4*16*4);
		objectMaterials.width = 16;
		objectMaterials.height = 4;
		var mTex = createTexture(gl, objectMaterials, 2);

		if (DEBUG) console.log('Set up WebGL: '+(Date.now()-t0)+' ms');

		var resize = function() {
			// Disabled HiDPI because those machines don't have enough FLOPS per pixel. 
			// FIXME Re-enable in 2022.
			var editor = document.body.classList.contains("editor");
			glc.width = (window.innerWidth); // * (window.mobile ? 1 : (window.devicePixelRatio || 1));
			glc.height = (window.innerHeight - (editor ? 200 : 0)); // * (window.mobile ? 1 : (window.devicePixelRatio || 1));
			iResolution[0] = glc.width;
			iResolution[1] = glc.height;
			gl.viewport(0,0, glc.width, glc.height);
			u3fv(gl, p, 'iResolution', iResolution);
			forceRedraw = true;
		};


		setStaticShader();


		var t = 0;
		var mouse = new Float32Array(4);

		var useFourView = false;

		var tDown = 0;

		var down = false;
		var mouseMovedEnough = false;
		var pick = -2;

		var displayPlaneIntersect = vec3();
		var previousDisplayPlaneIntersect = vec3();
		var cameraNormal = vec3();
		var motion = vec3();

		window.addEventListener('wheel', function(ev) {
			if (ev.target !== glc) return;
			ev.preventDefault();
			var d = ev.deltaY;
			cameraTarget[3] *= Math.pow(1.001, d);
			cameraTarget[3] = Math.min(Math.max(cameraTarget[3], 0.1), 10);
			forceRedraw = true;
		}, false);

		var objectMoved = false;

		window.onmousedown = function(ev) {
			objectMoved = false;
			if (ev.target !== glc) return;
			if (ev.button !== 0) {
				//useFourView = !useFourView;
				//ev.preventDefault();
				return;
			}
			mouse[2] = ev.layerX;
			mouse[3] = glc.offsetHeight-ev.layerY;
			mouse[0] = mouse[2];
			mouse[1] = mouse[3];
			mouseMovedEnough = false;
			down = true;
			tDown = t;
			getEye(useFourView, iResolution, cameraPos, cameraTarget, mouse, cpos);
			getDir(useFourView, iResolution, cameraPos, cameraTarget, mouse, cdir);
			pick = trace(cpos, cdir, objectPositions).pick;
			if (pick >= 0) {
				target = pick;
				normalize(sub(cameraTarget, cameraPos, cameraNormal));
				traceDisplayPlaneAt(cameraPos, cdir, spheres[target].position, cameraNormal, displayPlaneIntersect);
				previousDisplayPlaneIntersect.set(displayPlaneIntersect);
				setCurrentObject(spheres[target].name);
			} else {
				setCurrentObject("Camera");
			}
			ev.preventDefault();
			forceRedraw = true;
		};

		window.onmouseup = function(ev) {
			mouse[2] = -1;
			mouse[3] = -1;
			if (down) {
				if (pick >= 0) {
					pick = -2;
				}
				target = -2;
				down = false;
				ev.preventDefault();
				forceRedraw = true;
				if (objectMoved) {
					addKeyframe();
					undoStack.addState();
				}
			}
		};

		window.onmousemove = function(ev) {
			if (down) {
				var mx = ev.layerX;
				var my = (glc.offsetHeight-ev.layerY);
				if (target >= 0) {
					mouse[0] = ev.layerX;
					mouse[1] = glc.offsetHeight-ev.layerY;
					getDisplayPlaneIntersect(useFourView, iResolution, cameraPos, cameraTarget, mouse, spheres[target].position, displayPlaneIntersect);
					var dx = mouse[2]-mouse[0];
					var dy = mouse[3]-mouse[1];
					mouseMovedEnough = mouseMovedEnough || ((dx*dx + dy*dy) > 5*5);
					if (mouseMovedEnough) {
						spheres[target].position.set(displayPlaneIntersect);
						previousDisplayPlaneIntersect.set(displayPlaneIntersect);
						objectMoved = true;
					}
				} else {
					var dx = mx - mouse[0];
					var dy = my - mouse[1];
					dx *= 0.1;
					dy *= 0.1;

					motion[0] = -dx;
					motion[1] = -dy;
					motion[2] = 0;

					xyz(up, Math.sin(cameraPos[3]), Math.cos(cameraPos[3]), 0);
					normalize(sub(cameraTarget, cameraPos, zaxis));
					normalize(cross(up, zaxis, xaxis));
					normalize(cross(zaxis, xaxis, yaxis));
					cdir[0] = dot([xaxis[0], yaxis[0], zaxis[0]], motion);
					cdir[1] = dot([xaxis[1], yaxis[1], zaxis[1]], motion);
					cdir[2] = dot([xaxis[2], yaxis[2], zaxis[2]], motion);

					if (ev.shiftKey) {
						add(cameraPos, cdir, cameraPos);
						add(cameraTarget, cdir, cameraTarget);
					} else {
						scale(cdir, 0.5, cdir);
						sub(cameraTarget, cdir, cameraTarget);
					}
				}
				forceRedraw = true;
			}
			mouse[0] = ev.layerX;
			mouse[1] = glc.offsetHeight-ev.layerY;
		};


		var framesPerSecond = 12;

		var motionVector = vec3();
		var rollSpeed = 0;
		var downMask = {};

		window.onkeydown = function(ev) {
			if (ev.ctrlKey || ev.metaKey) {
				if (ev.code === 'KeyZ') {
					if (ev.shiftKey) {
						redo();
					} else {
						undo();
					}
				}
				if (ev.code === 'KeyC') {
					copyKeyframe();
				}
				if (ev.code === 'KeyV') {
					pasteKeyframe();
				}
				return;
			}
			if (downMask[ev.keyCode]) return;
			downMask[ev.keyCode] = true;
			var char = String.fromCharCode(ev.keyCode).toLowerCase();
			switch(char) {
			case 'w':
				// Go forward
				motionVector[2] += 1;
				break;
			case 's':
				// Go backward
				motionVector[2] += -1;
				break;
			case 'a':
				// Go left
				motionVector[0] += -1;
				break;
			case 'd':
				// Go right
				motionVector[0] += 1;
				break;
			case 'r':
				// Go up
				motionVector[1] += 1;
				break;
			case 'f':
				// Go down
				motionVector[1] += -1;
				break;
			case 'e':
				rollSpeed += 1;
				break;
			case 'q':
				rollSpeed += -1;
				break;
			default:

			}
			forceRedraw = true;
		};

		window.onkeyup = function(ev) {
			if (!downMask[ev.keyCode]) return;
			downMask[ev.keyCode] = false;
			switch(ev.code) {
			case 'KeyW':
				// Go forward
				motionVector[2] -= 1;
				break;
			case 'KeyS':
				// Go backward
				motionVector[2] -= -1;
				break;
			case 'KeyA':
				// Go left
				motionVector[0] -= -1;
				break;
			case 'KeyD':
				// Go right
				motionVector[0] -= 1;
				break;
			case 'KeyR':
				// Go up
				motionVector[1] -= 1;
				break;
			case 'KeyF':
				// Go down
				motionVector[1] -= -1;
				break;
			case 'KeyC':
				addKeyframe();
				undoStack.addState();
				break;
			case 'KeyZ':
				if (ev.shiftKey) {
					goToPreviousKeyframe();
				} else if (ev.altKey) {
					goToBeginning();
				} else {
					goToPreviousFrame();						
				}
				break;
			case 'KeyX':
				if (ev.shiftKey) {
					goToNextKeyframe();
				} else if (ev.altKey) {
					goToEnd();
				} else {
					goToNextFrame();
				}
				break;
			case 'KeyE':
				rollSpeed -= 1;
				break;
			case 'KeyQ':
				rollSpeed -= -1;
				break;
			case 'Space':
				ev.preventDefault();
				togglePlay();
				break;
			case 'Delete':
				ev.preventDefault();
				deleteSelectedKeyframe();
				break;
			case 'Backspace':
				ev.preventDefault();
				deleteSelectedKeyframe();
				break;
			default:
			}
			forceRedraw = true;
		};

		document.querySelector('.animation-editor .play').addEventListener('click', function(ev) {
			ev.preventDefault();
			togglePlay();
			forceRedraw = true;
		}, false);

		document.querySelector('.show-editor-controls .play').addEventListener('click', function(ev) {
			ev.preventDefault();
			togglePlay();
			forceRedraw = true;
		}, false);

		document.querySelector('.animation-editor .previous-frame').addEventListener('click', function(ev) {
			ev.preventDefault();
			goToPreviousFrame();
			forceRedraw = true;
		}, false);

		document.querySelector('.animation-editor .previous-keyframe').addEventListener('click', function(ev) {
			ev.preventDefault();
			goToPreviousKeyframe();
			forceRedraw = true;
		}, false);

		document.querySelector('.animation-editor .rewind').addEventListener('click', function(ev) {
			ev.preventDefault();
			goToBeginning();
			forceRedraw = true;
		}, false);

		document.querySelector('.animation-editor .next-frame').addEventListener('click', function(ev) {
			ev.preventDefault();
			goToNextFrame();
			forceRedraw = true;
		}, false);
		
		document.querySelector('.animation-editor .next-keyframe').addEventListener('click', function(ev) {
			ev.preventDefault();
			goToNextKeyframe();
			forceRedraw = true;
		}, false);

		document.querySelector('.animation-editor .fast-forward').addEventListener('click', function(ev) {
			ev.preventDefault();
			goToEnd();
			forceRedraw = true;
		}, false);

		var eot = { downX: null };
		document.querySelector('.end-of-time').addEventListener('mousedown', function(ev) {
			ev.preventDefault();
			eot.downX = ev.clientX;
			forceRedraw = true;
			objectMoved = false;
		}, false);

		window.addEventListener('mousemove', function(ev) {
			if (eot.downX !== null) {
				ev.preventDefault();
				var delta = (ev.clientX - eot.downX);
				eot.downX = ev.clientX;
				animationDuration += delta / (framesPerSecond * 8);
				scrollIntoViewIfNeeded(document.querySelector('.end-of-time'));
				updateKeyframes();
				forceRedraw = true;
				objectMoved = true;
			}
		}, false);

		window.addEventListener('mouseup', function(ev) {
			if (eot.downX !== null) {
				ev.preventDefault();
				eot.downX = null;
				animationDuration = Math.round(animationDuration * framesPerSecond) / framesPerSecond;
				updateKeyframes();
				forceRedraw = true;
				if (objectMoved) {
					undoStack.addState();
				}
			}
		}, false);

		document.querySelector('.new-keyframe').addEventListener('click', function(ev) {
			addKeyframe();
			undoStack.addState();
			forceRedraw = true;
			this.blur();
		}, false);

		document.querySelector('.delete-keyframe').addEventListener('click', function(ev) {
			deleteSelectedKeyframe();
			undoStack.addState();
			forceRedraw = true;
			this.blur();
		}, false);

		document.querySelector('.delete-all-keyframes').addEventListener('click', function(ev) {
			deleteAllKeyframes();
			undoStack.addState();
			forceRedraw = true;
			this.blur();
		}, false);

		document.querySelector('.save-animation').addEventListener('click', function(ev) {
			var anim = serializeTimeline();
			var blob = new Blob([anim]);
			var url = window.URL.createObjectURL(blob);
			var a = document.createElement('a');
			a.download = 'fhtranim.json';
			a.href = url;
			a.click();
			window.URL.revokeObjectURL(url);
			forceRedraw = true;
			this.blur();
		}, false);

		document.querySelector('.load-animation').addEventListener('click', function(ev) {
			var input = document.createElement('input');
			input.type = 'file'
			input.onchange = function(ev) {
				var file = ev.target.files[0];
				var fr = new FileReader();
				fr.onload = function() {
					loadTimeline(fr.result);
					goToBeginning();
					undoStack.addState();
				};
				fr.readAsText(file);
			};
			input.click();
			forceRedraw = true;
			this.blur();
		}, false);

		document.querySelector('.shot-mode').addEventListener('click', function(ev) {
			shotMode = !shotMode;
			forceRedraw = true;
			this.blur();
		}, false);

		document.querySelector('.render-shot').addEventListener('click', function(ev) {
			renderHighRes = true;
			forceRedraw = true;
			playing = false;
			this.blur();
		}, false);

		document.querySelector('.hide-editor').addEventListener('click', function(ev) {
			document.body.classList.remove('editor');
			resize();
			this.blur();
		}, false);

		var sphereUID = 16;
		document.querySelector('.create-object').addEventListener('click', function(ev) {
			createObject("Sphere " + sphereUID++);
			this.blur();
		}, false);

		document.querySelector('.delete-object').addEventListener('click', function(ev) {
			deleteSelectedObject();
			this.blur();
		}, false);

		document.querySelector('.show-editor').addEventListener('click', function(ev) {
			document.body.classList.add('editor');
			resize();
			this.blur();
		}, false);

		var objectSelect = document.querySelector('.object-select select');

		objectSelect.addEventListener('change', function(ev) {
			setCurrentObject(this.value);
			forceRedraw = true;
		}, false);

		objectSelect.addEventListener('keydown', function(ev) {
			ev.preventDefault();
		}, false);

		objectSelect.addEventListener('keyup', function(ev) {
			ev.preventDefault();
		}, false);

		var curveEditor = document.querySelector('.curve-editor svg');
		draggableCurve(curveEditor, function() {
			if (selectedKeyframe === null) {
				return [0, 0, 0.25, 0.25, 0.75, 0.75, 1, 1];
			}
			return selectedKeyframe.tweenCurve;
		});

		var selectedKeyframe = null;

		var resizeCurve = function() {
			plotFCurve(document.querySelector('.curve-editor svg'), recording, framesPerSecond, animationDuration);
		};

		window.addEventListener('resize', resizeCurve, false);

		var svg = document.querySelector('.curveEditorCanvas');
		var fcc = svg.querySelector('.f-curve-container');

		svg.addEventListener('mousedown', function(ev) {
			ev.preventDefault();
			if (ev.target.tagName.toLowerCase() === 'svg') {
				svg.down = true;
				svg.sx = ev.clientX;
				svg.sy = ev.clientY;
				forceRedraw = true;
				objectMoved = false;
			}
		}, false);

		window.addEventListener('mousemove', function(ev) {
			if (svg.down) {
				ev.preventDefault();
				var dx = ev.clientX - svg.sx;
				var dy = ev.clientY - svg.sy;
				svg.sx = ev.clientX;
				svg.sy = ev.clientY;
				var m = fcc.getCTM();
				// m.e += dx;
				m.f += dy;
				fcc.transform.baseVal.initialize(fcc.transform.baseVal.createSVGTransformFromMatrix(m));
				forceRedraw = true;
				objectMoved = true;
			}
		}, false);

		window.addEventListener('mouseup', function(ev) {
			if (svg.down) {
				ev.preventDefault();
				svg.down = false;
				forceRedraw = true;
				if (objectMoved) {
					undoStack.addState();
				}
			}
		}, false);

		// svg.addEventListener('wheel', function(ev) {
		// 	ev.preventDefault();
		// 	var df = Math.pow(1.001, ev.deltaY);
		// 	var m = fcc.getCTM();
		// 	m.d *= df;
		// 	fcc.transform.baseVal.initialize(fcc.transform.baseVal.createSVGTransformFromMatrix(m));
		// });

		var setSelectedKeyframe = function(kf) {
			selectedKeyframe = kf;
			plotFCurve(document.querySelector('.curve-editor svg'), recording, framesPerSecond, animationDuration);
		};

		var deselectKeyframe = function(kf) {
			selectedKeyframe = null;
			plotFCurve(document.querySelector('.curve-editor svg'), recording, framesPerSecond, animationDuration);
		};

		var currentObjectName = null;
		var setCurrentObject = function(name) {
			document.querySelector('.object-select select').value = name;
			recording = timeline[name];
			currentObject = scene[name];
			currentObjectName = name;
			var index = getCurrentKeyframeIndex();
			if (index !== null) {
				setSelectedKeyframe(recording[0]);
			} else {
				deselectKeyframe();
			}
			updateKeyframes();
			if (currentObject.transmit) {
				mixers[0].set(currentObject.transmit);
			}
			if (currentObject.emission) {
				mixers[1].set(currentObject.emission);
			}
			if (currentObject.rotorTransmit) {
				mixers[2].set(currentObject.rotorTransmit);
			}
			if (currentObject.rotorEmission) {
				mixers[3].set(currentObject.rotorEmission);
			}
			if (currentObject.specular) {
				ranges[0].value = currentObject.specular;
			}
			if (currentObject.rotorSpecular) {
				ranges[1].value = currentObject.rotorSpecular;
			}
		};

		var goToBeginning = function() {
			animationTime = 0;
			globalAnimationTime = 0;
		};

		var goToEnd = function() {
			animationTime = animationDuration;
			globalAnimationTime = animationDuration;
		};

		var addKeyframe = function(kf) {
			if (!kf) {
				kf = {};
				var fCurves = {};
				var tweenCurves = {};
				kf.time = Math.floor(animationTime * (framesPerSecond)) / (framesPerSecond);
				kf.tweenCurves = tweenCurves;
				kf.fCurves = fCurves;
				for (var i in currentObject) {
					if (specialKeys[i]) { 
						continue;
					}
					kf[i] = [].slice.call(currentObject[i]);
					fCurves[i] = kf[i].map(function(k) {
						return [-3/framesPerSecond, 0, +3/framesPerSecond, 0];
					});
					tweenCurves[i] = kf[i].map(function(k) { return [0, 0, 0.25, 0.25, 0.75, 0.75, 1, 1]; });
				}
			}
			var added = false;
			for (var i=0; i<recording.length; i++) {
				if (recording[i].time > kf.time) {
					var d = 0;
					if (i > 0 && recording[i-1].time === kf.time) {
						d = 1;
						i--;
					}
					recording.splice(i, d, kf);
					added = true;
					break;
				}
			}
			if (!added) {
				if (recording.length > 0 && recording[recording.length-1].time === kf.time) {
					recording.pop();
				}
				recording.push(kf);
			}
			if (recording.length === 1 && kf.time !== 0) {
				var zeroKf = {};
				for (var i in kf) {
					zeroKf[i] = kf[i];
				}
				zeroKf.time = 0;
				recording.unshift(zeroKf);
			}
			for (var i=0; i<recording.length; i++) {
				var f = recording[i];
				for (var k in kf) {
					if (specialKeys[k]) {
						continue;
					}
					if (f[k] === undefined) {
						f[k] = [].slice.call(kf[k]);
						f.fCurves[k] = kf[k].map(function(k) {
							return [-3/framesPerSecond, 0, +3/framesPerSecond, 0];
						});
						f.tweenCurves[k] = kf[k].map(function(k) { return [0, 0, 0.25, 0.25, 0.75, 0.75, 1, 1]; });
					}
				}
			}
			setSelectedKeyframe(kf);
			smoothKeyframes();
			updateKeyframes();
		};

		var looping = true;

		var smoothKeyframes = function() {
			var px, py, nx, ny, kf, x;
			var startIndex = looping ? 0 : 1;
			var endIndex = recording.length - (looping ? 0 : 1);
			for (var i = startIndex; i < endIndex; i++) {
				kf = recording[i];
				x = kf.time;
				var curves = kf.fCurves;
				for (var key in curves) {
					for (var j = 0; j < curves[key].length; j++) {
						var curve = curves[key][j];
						if (curve.manual) {
							continue;
						}

						if (i === 0) {
							px = recording[endIndex-1].time - animationDuration;
							py = recording[endIndex-1][key][j];
						} else {
							px = recording[i-1].time;
							py = recording[i-1][key][j];
						}

						if (i === recording.length-1) {
							nx = recording[0].time + animationDuration;
							ny = recording[0][key][j];
						} else {
							nx = recording[i+1].time;
							ny = recording[i+1][key][j];
						}

						var dx = nx-px;
						var dy = ny-py;
						var d = Math.abs(dx);
						var d1 = Math.abs(x-px);
						var d2 = Math.abs(nx-x);
						var md = Math.min(d1, d2);
						md = 0.33 * md / d;
						curve[0] = - dx * md;
						curve[1] = - dy * md;
						curve[2] = + dx * md;
						curve[3] = + dy * md;
					}
				}
			}
		};

		var modifyKeyframe = function(keyframe, modifications) {
			if (deleteKeyframe(keyframe)) {
				for (var i in modifications) {
					keyframe[i] = modifications[i];
				}
				addKeyframe(keyframe);
			}
		};

		var deleteKeyframe = function(keyframe) {
			var idx = recording.indexOf(keyframe);
			if (idx > -1) {
				recording.splice(idx, 1);
				return true;
			}
			return false;
		};

		var deleteSelectedKeyframe = function() {
			if (selectedKeyframe) {
				deleteKeyframe(selectedKeyframe);
				deselectKeyframe();
				updateKeyframes();			
			}
		};

		var deleteAllKeyframes = function() {
			recording.splice(0);
			deselectKeyframe();
			updateKeyframes();
		};

		var togglePlay = function() {
			if (!playing) {
				play();
			} else {
				pause();
			}
		};

		var play = function() {
			playing = true;
			document.body.classList.add('playing');
			forceRedraw = true;
		};

		var pause = function() {
			playing = false;
			document.body.classList.remove('playing');
			forceRedraw = true;
		};

		var getCurrentKeyframeIndex = function() {
			if (recording.length === 0) {
				return null;
			}
			var kf = 0;
			for (var i=1; i<recording.length; i++) {
				if (recording[i].time > animationTime) {
					break;
				}
				kf = i;
			}
			return kf;
		};

		var goToNextFrame = function() {
			animationTime = Math.floor(animationTime * framesPerSecond + 1) / framesPerSecond;
			if (animationTime > animationDuration) {
				animationTime = animationDuration;
			}
			globalAnimationTime = animationTime;
		};

		var goToPreviousFrame = function() {
			animationTime = Math.floor(animationTime * framesPerSecond - 1) / framesPerSecond;
			if (animationTime < 0) {
				animationTime = 0;
			}
			globalAnimationTime = animationTime;
		};

		var goToNextKeyframe = function() {
			var idx = getCurrentKeyframeIndex();
			if (idx !== null && idx < recording.length-1) {
				animationTime = recording[idx+1].time;
				globalAnimationTime = animationTime;
			}
		};

		var goToPreviousKeyframe = function() {
			var idx = getCurrentKeyframeIndex();
			if (idx !== null) {
				if (idx > 0 && recording[idx].time + (playing ? 0.5 : 0) >= animationTime) {
					animationTime = recording[idx-1].time;
				} else {
					animationTime = recording[idx].time;
				}
				globalAnimationTime = animationTime;
			}
		};

		var goToTimeStripTime = function(ev, moving) {
			var frame = ((ev.clientX - timeStrip.getBoundingClientRect().left) / 8);
			var timeInSeconds = frame / framesPerSecond;

			if (!moving && ev.target.classList.contains('keyframe')) {
				animationTime = ev.target.time;
				globalAnimationTime = animationTime;
				setSelectedKeyframe(ev.target.keyframe);
				updateKeyframes();
			} else {
				if (downKeyframe !== null) {
					selectedKeyframe = downKeyframe;
					modifyKeyframe(downKeyframe, {time: Math.round(frame) / framesPerSecond});
					timeInSeconds = downKeyframe.time;
					updateKeyframes();
				} else {
					if (selectedKeyframe !== null) {
						deselectKeyframe();
						updateKeyframes();
					}
				}
				animationTime = Math.max(0, timeInSeconds);
				globalAnimationTime = animationTime;
			}
			ev.preventDefault();
		};

		var timeStrip = document.querySelector('.timestrip');
		var downKeyframe = null;
		var clipboardKeyframe = null;

		var copyKeyframe = function() {
			clipboardKeyframe = selectedKeyframe;
		};

		var objectCopy = function(o) {
			if (typeof o === 'object') {
				var res;
				if (Array.prototype.isPrototypeOf(o)) {
					res = o.map(objectCopy);
				} else {
					res = {};
					for (var i in o) {
						res[i] = objectCopy(o[i]);
					}
				}
				return res;
			} else {
				return o;
			}
		}

		var pasteKeyframe = function() {
			if (clipboardKeyframe) {
				if (!selectedKeyframe) {
					addKeyframe();
				}
				for (var i in clipboardKeyframe) {
					if (i !== 'time') {
						selectedKeyframe[i] = objectCopy(clipboardKeyframe[i]);
					}
				}
				smoothKeyframes();
				updateKeyframes();
				undoStack.addState();
			}
		};

		timeStrip.addEventListener('mousedown', function(ev) {
			ev.preventDefault();
			if (!ev.target.classList.contains('end-of-time')) {
				if (ev.target.classList.contains('keyframe')) {
					downKeyframe = ev.target.keyframe;
				}
				this.down = true;
				goToTimeStripTime(ev, false);
				forceRedraw = true;
			}
		}, false);

		var closeMenu = function() {
			var oldMenus = [].slice.call(document.querySelectorAll('.contextmenu'));
			for (var i=0; i<oldMenus.length; i++) {
				oldMenus[i].parentNode.removeChild(oldMenus[i]);
			}
			var oldMenus = [].slice.call(document.querySelectorAll('.contextmenu-background'));
			for (var i=0; i<oldMenus.length; i++) {
				oldMenus[i].parentNode.removeChild(oldMenus[i]);
			}
		};

		var contextMenu = function(x, y, items) {
			var menu = document.createElement('div');
			menu.className = 'contextmenu';
			document.body.appendChild(menu);
			var bg = document.createElement('div');
			bg.className = 'contextmenu-background';
			document.body.appendChild(bg);
			bg.onclick = function(ev) {
				closeMenu();
			};
			items.forEach(function(it) {
				var name = it[0];
				var action = it[1];
				var menuItem = document.createElement('div');
				if (name === '-') {
					menuItem.classList.add('spacer');
				} else {
					menuItem.classList.add('-' + name.toLowerCase().replace(/\s+/g, '-'));
					menuItem.textContent = name;
				}
				if (action) {
					menuItem.onclick = function(ev) {
						action(ev);
						closeMenu();
						ev.preventDefault();
					};
				} else {
					menuItem.classList.add('disabled');
				}
				menu.appendChild(menuItem);
			});
			var bbox = menu.getBoundingClientRect();
			if (x + bbox.width > window.innerWidth) {
				menu.style.right = (window.innerWidth-x) + 'px';
			} else {
				menu.style.left = x + 'px';
			}
			if (y + bbox.height > window.innerHeight) {
				menu.style.bottom = (window.innerHeight-y) + 'px';
			} else {
				menu.style.top = y + 'px';				
			}
		};

		timeStrip.addEventListener('contextmenu', function(ev) {
			var menuItems = [
				['Copy', selectedKeyframe ? copyKeyframe : null],
				['Paste', clipboardKeyframe ? pasteKeyframe : null],
			];
			if (selectedKeyframe) {
				menuItems.push(
					['-'],
					['Delete', function() {
						deleteSelectedKeyframe();
						undoStack.addState();
					}]
				);
			}
			contextMenu(ev.clientX, ev.clientY, menuItems);
			ev.preventDefault();
		}, false);

		window.addEventListener('mousemove', function(ev) {
			if (timeStrip.down) {
				ev.preventDefault();
				goToTimeStripTime(ev, true);
				forceRedraw = true;
			}
		}, false);

		window.addEventListener('mouseup', function(ev) {
			if (timeStrip.down) {
				ev.preventDefault();
				timeStrip.down = false;
				downKeyframe = null;
				forceRedraw = true;
			}
		}, false);

		var updateKeyframes = function() {
			var timeStrip = document.querySelector('.timestrip .keyframes');
			timeStrip.innerHTML = '';
			for (var i=0; i<recording.length; i++) {
				var kf = document.createElement('div');
				kf.className = 'keyframe';
				if (selectedKeyframe === recording[i]) {
					kf.className += ' selected';
				}
				kf.time = recording[i].time;
				kf.keyframe = recording[i];
				kf.style.left = (
					recording[i].time // seconds
					* framesPerSecond // fps
					* 8 // keyframe width
				) + 'px';
				timeStrip.appendChild(kf);
			}
			document.querySelector('.end-of-time').style.left = ((animationDuration * framesPerSecond + 1) * 8) + 'px';
			document.querySelector('.active-time').style.width = ((animationDuration * framesPerSecond + 1) * 8) + 'px';
			plotFCurve(document.querySelector('.curve-editor svg'), recording, framesPerSecond, animationDuration);
		};

		var getKeyframes = function(recording, animationTime, looping) {
			if (recording.length === 0) {
				return null;
			}
			var f0 = recording[0], f1 = f0;
			if (f0.time < animationTime) {
				for (var i = 1; i < recording.length; i++) {
					f1 = recording[i];
					if (recording[i].time > animationTime) {
						break;
					}
					f0 = f1;
				}
			}
			var f = (animationTime - f0.time) / (f1.time - f0.time);
			if (looping && f1 === f0) {
				f1 = recording[0];
				f = (animationTime - f0.time) / ((animationDuration+f1.time) - f0.time);
			}
			f = Math.min(1, Math.max(0, isNaN(f) ? 0 : f));

			return {start: f0, end: f1, tweenPosition: f};
		};

		var interpolateKeyframes = function(keyName, startFrame, endFrame, t, target) {
			var v0 = startFrame[keyName];
			var v1 = endFrame[keyName];
			var dst = target[keyName];
			var startTime = startFrame.time;
			var endTime = endFrame.time;
			var timeFactor;
			if (endTime <= startTime) {
				timeFactor = 0;
				if (looping) {
					endTime = (animationDuration + endFrame.time);
					timeFactor = 1 / (endTime - startTime);
				}
			} else {
				timeFactor = 1 / (endTime - startTime);
			}
			var curve = [];
			for (var i=0; i<v0.length; i++) {
				var ct = curvePoint(t, startFrame.tweenCurves[keyName][i]);
				var sp = startFrame.fCurves[keyName][i];
				var ep = endFrame.fCurves[keyName][i];
				curve[0] = 0;
				curve[1] = v0[i];
				curve[2] = ((startTime + sp[2]) - startTime) * timeFactor;
				curve[3] = v0[i] + sp[3];
				curve[4] = ((endTime + ep[0]) - startTime) * timeFactor;
				curve[5] = v1[i] + ep[1];
				curve[6] = 1;
				curve[7] = v1[i];
				var cp = curvePoint(ct, curve);
				dst[i] = cp;
			}
		};

		var applyTimeline = function(timeline, target, animationTime) {
			var kfs = getKeyframes(timeline, animationTime, looping);
			if (kfs !== null) {
				for (var i in kfs.start) {
					if (!specialKeys[i]) {
						interpolateKeyframes(i, kfs.start, kfs.end, kfs.tweenPosition, target);
					}
				}
			}
		};

		var applyTimelines = function(animationTime) {
			for (var key in timeline) {
				if (key === 'Camera' && currentObject !== scene['Camera']) {
					continue;
				}
				applyTimeline(timeline[key], scene[key], animationTime);
			}
		};

		window.onresize = resize;

		var blurred = false;
		window.onblur = function() {
			blurred = true;
		};
		window.onfocus = function() {
			blurred = false;
		};

		var rebuildScene = function() {
			for (var i=0; i<spheres.length; i++) {
				var s = spheres[i];
				scene[s.name] = {
					id: i, 
					name: s.name, 
					position: s.position,
					transmit: s.transmit,
					specular: s.specular,
					emission: s.emission,
					rotorTransmit: s.rotorTransmit,
					rotorSpecular: s.rotorSpecular,
					rotorEmission: s.rotorEmission
				};
			}
			objectSelect.innerHTML = '';
			for (var name in scene) {
				var option = document.createElement('option');
				option.value = name;
				option.textContent = name;
				objectSelect.appendChild(option);
			}
		};

		var createObject = function(name, position, transmit, specular, emission) {
			var j = spheres.length;
			if (j > 15 || scene[name]) {
				// Only 16 objects supported, sorry not sorry
				return;
			}
			var c = (j % 2 * 0.8) + 0.15;
			transmit = transmit || new Float32Array([c,c,c]);
			emission = emission || new Float32Array([0,0,0]);
			specular = specular === undefined ? [16] : specular;
			spheres[j] = {
				position: position || new Float32Array([Math.random()*10-5,Math.random()*10-5,Math.random()*10-5,1]),
				transmit: transmit,
				specular: specular,
				emission: emission,
				rotorTransmit: new Float32Array([0.95, 0.15, 0.1]),
				rotorSpecular: [16],
				rotorEmission: new Float32Array([0,0,0]),
				name: name,
				html: null
			};
			var div = document.createElement('div');
			div.innerHTML = "<h3>Title " + j + "</h3><p>This is some text.</p>";
			contentContainer.appendChild(div);
			spheres[j].html = div;

			rebuildScene();
			timeline[name] = [];

			forceRedraw = true;
		};

		var deleteObject = function(obj) {
			var idx = obj.id;
			if (idx >= 0) {
				sphere = spheres[obj.id]
				delete timeline[sphere.name];
				delete scene[sphere.name];
				sphere.html.parentNode.removeChild(sphere.html);
				spheres.splice(idx, 1);
				for (var i=idx*4; i<objectPositions.length-4; i++) {
					objectPositions[i] = objectPositions[i+4];
					objectVelocities[i] = objectVelocities[i+4];
					objectMaterials[i] = objectMaterials[i+4];
					objectMaterials[i+16*4] = objectMaterials[i+4+16*4];
					objectMaterials[i+16*4*2] = objectMaterials[i+4+16*4*2];
					objectMaterials[i+16*4*3] = objectMaterials[i+4+16*4*3];
				}
				objectPositions[objectPositions.length-1] = -1;
				rebuildScene();
				setCurrentObject("Camera");
				forceRedraw = true;
			}
		};

		var deleteSelectedObject = function() {
			if (currentObject) {
				deleteObject(currentObject);
			}
		};

		var mixers = [];
		var ranges = [];

		document.querySelectorAll('.color-mixer').forEach(function(el) {
			var bbox = el.getBoundingClientRect();
			mixers.push(new ColorMixer(el, 160, 160, function(col) {
				var id = currentObject.id;
				if (id >= 0) {
					var dst = spheres[id][el.dataset.target];
				} else if (currentObject === scene.Sky) {
					var dst = scene.Sky[el.dataset.target];
				}
				if (dst) {
					dst[0] = col[0];
					dst[1] = col[1];
					dst[2] = col[2];
					addKeyframe();
					undoStack.addState();
					forceRedraw = true;
				}
			}));
		});

		document.querySelectorAll('.specular input').forEach(function(el) {
			ranges.push(el);
			el.addEventListener('change', function(ev) {
				var id = currentObject.id;
				if (id >= 0) {
					var dst = spheres[id][el.dataset.target];
				} else if (currentObject === scene.Sky) {
					var dst = scene.Sky[el.dataset.target];
				}
				if (dst) {
					dst[0] = parseFloat(this.value);
					addKeyframe();
					undoStack.addState();
					forceRedraw = true;
				}
			}, false);
		});


		var lightPos = vec3(-8.5, 3.5, 5.4);

		var cameraPos = new Float32Array([0,0, -13, 0]); // xyz, roll angle
		var previousCameraPos = new Float32Array([0,0, -13, 0]); // xyz, roll angle
		var cameraPosV = new Float32Array(4); // xyz, roll angle
		var cameraTarget = new Float32Array([0,0,0,1]); // xyz, zoom
		var previousCameraTarget = new Float32Array([0,0,0,1]); // xyz, zoom
		var cameraTargetV = new Float32Array([0,0,0,0]); // xyz, zoom
		var cdir = vec3(0.0);
		var cpos = vec3(0.0);
		var target = -2;


		var playing = false;
		var t = 0, pt = 0, dt = 0;
		var animationTime = 0;
		var previousAnimationTime = 0;
		var globalAnimationTime = animationTime;
		var animationDuration = 5;

		var timeline = {};


		var scene = {};
		scene.Sky = {id: -2, 
			position: lightPos,
			transmit: [1,0.5,0.2],
			emission: [0,1,1],
			rotorTransmit: [1,1,1],
			rotorEmission: [1,0,0],
			rotorSpecular: [128],
			specular: [192]
		};
		scene.Camera = {id: -2, position: cameraPos, target: cameraTarget};

		var spheres = [];
		var contentContainer = document.querySelector('.content-3d');
		for (j=0; j<9; j++) {
			createObject("Sphere " + j);
		}

		if (DEBUG) console.log('WebGL setup total: '+(Date.now()-t1)+' ms'); 

		var applyUndoState = function(state) {
			animationDuration = state.animationDuration;
			looping = true;
			if (state.version >= 1) {
				looping = state.looping;
			}
			timeline = state.timeline;
			applyTimelines(animationTime);
			setCurrentObject(currentObjectName);
			forceRedraw = true;
		};

		var getTimelineState = function() { 
			return {
				version: 1,
				looping: looping,
				animationDuration: animationDuration,
				timeline: timeline
			};
		};

		var serializeTimeline = function() {
			return JSON.stringify(getTimelineState());
		};

		var loadTimeline = function(string) {
			var obj = JSON.parse(string);
			if (obj.version === 0 || obj.version === 1) {
				applyUndoState(obj);
			}
		};


		var undo = function() {
			undoStack.undo();
		};

		var redo = function() {
			undoStack.redo();
		};

		for (var i in scene) {
			timeline[i] = [];
		}
		if (savedTimeline) {
			try {
				loadTimeline(savedTimeline);
			} catch (e) {
				e;
				// do nothing
			}
		}

		var undoStack = new UndoStack(loadTimeline, serializeTimeline);


		var recording, currentObject;
		setCurrentObject('Camera');

		if (!document.body.classList.contains("editor")) {
			play();
		}

		var shotMode = false;
		var renderHighRes = false;

		pt = t = performance.now() / 1000;
		var tick = function() {
			var cx0, cy0, cz0;
			var x0,y0,z0,r0, i,j;
			forceRedraw = forceRedraw || (dot(motionVector, motionVector) + rollSpeed*rollSpeed);
			// forceRedraw = forceRedraw || down;
			if ((!blurred && (playing || forceRedraw)) || (playing && window.noOnBlurPause)) {
				forceRedraw = false;
				if (window.startScript) {
					if (window.performance && performance.timing && performance.timing.navigationStart) {
						console.log('navigationStart to first frame: '+(Date.now()-performance.timing.navigationStart)+' ms');
					}
					console.log('script start to first frame: '+(Date.now()-window.startScript)+' ms');
					window.startScript = 0;
				}

				t = performance.now() / 1000;
				dt = t-pt;
				pt = t;

				var updateMotionBlur = false;
				var updateCameraMotionBlur = false;

				var playhead = document.querySelector('.playhead');
				if (playhead && document.body.classList.contains('editor')) {
					playhead.style.left = Math.floor(animationTime * framesPerSecond) * 8 + 'px';
					if (playing) {
						scrollIntoViewIfNeeded(playhead);
					}
				}

				if (playing || animationTime !== previousAnimationTime) {

					if (playing && animationTime > animationDuration) {
						animationTime = 0;
					}

					applyTimelines(animationTime);

					if (playing) {
						animationTime += dt;
						globalAnimationTime += dt;
					}

					previousAnimationTime = animationTime;

					updateMotionBlur = true;
					updateCameraMotionBlur = true;

				} else {

					xyz(up, Math.sin(cameraPos[3]), Math.cos(cameraPos[3]), 0);
					normalize(sub(cameraTarget, cameraPos, zaxis));
					normalize(cross(up, zaxis, xaxis));
					normalize(cross(zaxis, xaxis, yaxis));
					cdir[0] = dot([xaxis[0], yaxis[0], zaxis[0]], motionVector);
					cdir[1] = dot([xaxis[1], yaxis[1], zaxis[1]], motionVector);
					cdir[2] = dot([xaxis[2], yaxis[2], zaxis[2]], motionVector);

					scale(cdir, 10*dt, cdir);

					add(cameraPos, cdir, cameraPos);
					add(cameraTarget, cdir, cameraTarget);

					cameraPos[3] += rollSpeed * dt;

					if (length(cdir) > 0 || rollSpeed > 0) {
						updateCameraMotionBlur = true;
					}
					
				}

				if (playing) {
					document.body.classList.add('playing');
				} else {
					document.body.classList.remove('playing');
				}

				var moved = false;
				for (j=0; j<16; j++) {
					i = j*4;
					if (j >= spheres.length) {
						objectPositions[i+3] = -1;
						break;
					}
					var sphere = spheres[j];
					x0 = objectPositions[i];
					y0 = objectPositions[i+1];
					z0 = objectPositions[i+2];
					r0 = objectPositions[i+3];
					objectPositions[i] = sphere.position[0];
					objectPositions[i+1] = sphere.position[1];
					objectPositions[i+2] = sphere.position[2];
					objectPositions[i+3] = sphere.position[3];
					//if (updateMotionBlur) {
					var vx = (objectPositions[i]-x0)/dt;
					var vy = (objectPositions[i+1]-y0)/dt;
					var vz = (objectPositions[i+2]-z0)/dt;
					var vr = (objectPositions[i+3]-r0)/dt;
					moved = moved || vx || vy || vz || vr;
					if (!(shotMode || renderHighRes) || playing) {
						objectVelocities[i] = vx;
						objectVelocities[i+1] = vy;
						objectVelocities[i+2] = vz;
						objectVelocities[i+3] = vr;
					}
					//}
					objectMaterials[i] = sphere.transmit[0]*255;
					objectMaterials[i+1] = sphere.transmit[1]*255;
					objectMaterials[i+2] = sphere.transmit[2]*255;
					objectMaterials[i+3] = sphere.specular[0];
					objectMaterials[i+16*4] = sphere.emission[0]*255;
					objectMaterials[i+16*4+1] = sphere.emission[1]*255;
					objectMaterials[i+16*4+2] = sphere.emission[2]*255;
					objectMaterials[i+16*4*2] = sphere.rotorTransmit[0]*255;
					objectMaterials[i+16*4*2+1] = sphere.rotorTransmit[1]*255;
					objectMaterials[i+16*4*2+2] = sphere.rotorTransmit[2]*255;
					objectMaterials[i+16*4*2+3] = sphere.rotorSpecular[0];
					objectMaterials[i+16*4*3] = sphere.rotorEmission[0]*255;
					objectMaterials[i+16*4*3+1] = sphere.rotorEmission[1]*255;
					objectMaterials[i+16*4*3+2] = sphere.rotorEmission[2]*255;
					var el = sphere.html;
					trackElement(el, sphere.position, cameraPos, cameraTarget);
				}

				var cameraMoved = !( eq4(cameraPos, previousCameraPos) && eq4(cameraTarget, previousCameraTarget) );
				if (!(shotMode || renderHighRes) || playing) { // updateCameraMotionBlur) {
					sub4(cameraPos, previousCameraPos, cameraPosV);
					scale4(cameraPosV, 1/dt, cameraPosV);
					sub4(cameraTarget, previousCameraTarget, cameraTargetV);
					scale4(cameraTargetV, 1/dt, cameraTargetV);
				}
				previousCameraPos.set(cameraPos);
				previousCameraTarget.set(cameraTarget);

				forceRedraw = cameraMoved || moved;
				if (renderHighRes) { 
					setHiresShader();
					forceRedraw = false;
					renderHighRes = false;
				} else if (cameraMoved || playing || moved) {
					setAnimShader();
				} else {
					setStaticShader();
				}

				u4fv(gl, p, 'iCamera', cameraPos);
				u4fv(gl, p, 'iCameraTarget', cameraTarget);
				u4fv(gl, p, 'iCameraV', cameraPosV);
				u4fv(gl, p, 'iCameraTargetV', cameraTargetV);

				if (gl.floatTexture) {
					updateTexture(gl, pTex, objectBuf, 1);
				} else {
					u4fv(gl, p, 'iObject', objectPositions);
					u4fv(gl, p, 'iObjectV', objectVelocities);
				}
				updateTexture(gl, mTex, objectMaterials, 2);

				u3fv(gl, p, 'iLightPos', lightPos);
				u3fv(gl, p, 'iSkyColor', scene.Sky.emission);
				u3fv(gl, p, 'iHorizonColor', scene.Sky.rotorTransmit);
				u3fv(gl, p, 'iGroundColor', scene.Sky.rotorEmission);
				u3fv(gl, p, 'iSunColor', scene.Sky.transmit);
				u1f(gl, p, 'iSunSize', scene.Sky.rotorSpecular[0] / 255 * 8);
				u1f(gl, p, 'iSunBrightness', scene.Sky.specular[0] / 255 * 8);

				u1i(gl, p, 'iUseFourView', useFourView ? 1 : 0);

				u1f(gl, p, 'iGlobalTime', globalAnimationTime);
				u1f(gl, p, 'iPick', currentObject.id);
				u1f(gl, p, 'iISO', 200.0);
				u1f(gl, p, 'iShutterSpeed', 1/120);
				u1f(gl, p, 'iExposureCompensation', +0);
				u4fv(gl, p, 'iMouse', mouse);

				gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
				gl.drawArrays(gl.TRIANGLES, 0, 6);
			} else {
				t = performance.now() / 1000;
				dt = t-pt;
				pt = t;
			}
			mixers.forEach(function(m) { m.redraw() });
			requestAnimationFrame(tick, glc);
		};
		resize();
		tick();
		document.body.appendChild(glc);
	});
};

var ticker = function() {
	if (window.gl && window.curvePoint && window.createTexture) {
		init();
	} else {
		setTimeout(ticker, 0);
	}
};
ticker();

})();

